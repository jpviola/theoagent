import { streamText } from 'ai';
import { createAnthropic } from '@ai-sdk/anthropic';
import { gatherContextForQuery } from '@/lib/dataInjection';
import { tools } from '@/lib/tools';
import { SUBSCRIPTION_TIERS } from '@/lib/subscription-db';
import { supabase } from '@/lib/supabase';
import { createClient } from '@supabase/supabase-js';

// Service role client for bypassing RLS when creating profiles
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export const maxDuration = 60; // Important for tool calls

// Create custom Anthropic provider with settings
const anthropic = createAnthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

export async function POST(req: Request) {
  try {
    console.log('Chat route called');
    const { messages, mode = 'standard', subscriptionTier = 'free', userId } = await req.json();
    console.log('Chat route - received data:', { messagesCount: messages?.length, mode, userId });
    
    // Authenticate and validate user
    if (!userId) {
      console.log('Chat route - No userId provided');
      return new Response('Unauthorized', { status: 401 });
    }
    
    // Check user subscription and usage
    console.log('Chat route - Checking user profile for:', userId);
    const { data: profile, error } = await supabaseAdmin
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();
      
    console.log('Chat route - Profile query result:', { profile: !!profile, error: !!error });
    
    if (error || !profile) {
      console.log('Chat route - Profile error details:', error);
      
      // If profile doesn't exist, create it
      if (error?.code === 'PGRST116') {
        console.log('Chat route - Creating new profile for user:', userId);
        const { data: newProfile, error: createError } = await supabaseAdmin
          .from('profiles')
          .insert({
            id: userId,
            subscription_tier: 'free',
            usage_count_today: 0
          })
          .select()
          .single();
          
        if (createError) {
          console.log('Chat route - Failed to create profile:', createError);
          return new Response('Failed to create user profile', { status: 500 });
        }
        
        // Use the newly created profile
        console.log('Chat route - Using newly created profile');
        var userProfile = newProfile;
      } else {
        return new Response('User not found', { status: 404 });
      }
    } else {
      var userProfile = profile;
    }
    
    if (error || !profile) {
      return new Response('User not found', { status: 404 });
    }
    
    // Get subscription limits
    const limits = SUBSCRIPTION_TIERS[userProfile.subscription_tier as 'free' | 'plus' | 'expert'];
    
    // Check daily usage limits
    if (limits.limits.dailyMessages !== -1 && userProfile.usage_count_today >= limits.limits.dailyMessages) {
      return new Response('Daily usage limit exceeded', { status: 429 });
    }
    
    // Check mode access
    if (!limits.limits.modesAccess.includes(mode)) {
      return new Response('Mode not available for your subscription tier', { status: 403 });
    }
    
    // Increment usage count - simple approach for now
    const { error: updateError } = await supabase
      .from('profiles')
      .update({ usage_count_today: userProfile.usage_count_today + 1 })
      .eq('id', userId);
    
    if (updateError) {
      console.error('Error updating usage:', updateError);
    }
    
    // Create conversation record - also simplify this
    const { error: conversationError } = await supabaseAdmin
      .from('conversations')
      .insert({
        user_id: userId,
        mode_used: mode,
        message_count: 1
      });
      
    if (conversationError) {
      console.error('Error creating conversation:', conversationError);
    }
    
    // ===== RAG SYSTEM: Gather relevant biblical context =====
    const lastMessage = messages[messages.length - 1];
    const userQuery = lastMessage?.content || '';
    
    const relevantContext = gatherContextForQuery(userQuery);
    
    // Transform messages to support attachments (multimodal)
    const transformedMessages = messages.map((msg: Record<string, unknown>) => {
      if (msg.role === 'user' && msg.attachments && Array.isArray(msg.attachments) && msg.attachments.length > 0) {
        // Create multimodal content array
        const content: Array<Record<string, unknown>> = [];
        
        // Add text if present
        if (msg.content && msg.content !== '(Attached files)') {
          content.push({ type: 'text', text: msg.content });
        }
        
        // Add attachments
        (msg.attachments as Array<Record<string, unknown>>).forEach((attachment) => {
          if (attachment.type === 'image') {
            content.push({
              type: 'image',
              image: attachment.data, // base64 data URL
            });
          } else if (attachment.type === 'pdf') {
            // For PDFs, add a text note (Claude doesn't directly support PDF)
            content.push({
              type: 'text',
              text: `[PDF attached: ${attachment.name}. Please note: PDF content extraction is not yet implemented. Please describe the content or provide specific text from the PDF.]`,
            });
          }
        });
        
        return {
          role: msg.role,
          content: content.length > 0 ? content : msg.content,
        };
      }
      return {
        role: msg.role,
        content: msg.content,
      };
    });
    
    // Inject context into the conversation if found
    let enhancedMessages = transformedMessages;
    
    if (relevantContext && lastMessage && relevantContext.length > 100) {
      const lastTransformedMessage = enhancedMessages[enhancedMessages.length - 1];
      const currentContent = lastTransformedMessage.content;
      
      // Handle both string and array content
      if (typeof currentContent === 'string') {
        enhancedMessages = [
          ...enhancedMessages.slice(0, -1),
          {
            ...lastTransformedMessage,
            content: currentContent + relevantContext
          }
        ];
      } else if (Array.isArray(currentContent)) {
        // Add context as a text part to the content array
        enhancedMessages = [
          ...enhancedMessages.slice(0, -1),
          {
            ...lastTransformedMessage,
            content: [
              ...currentContent,
              { type: 'text', text: relevantContext }
            ]
          }
        ];
      }
      console.log('üìñ Context injected:', relevantContext.substring(0, 200) + '...');
    }
    // ===== END RAG SYSTEM =====

    // Add assistant prefill to force longer responses
    const finalMessage = enhancedMessages[enhancedMessages.length - 1];
    if (finalMessage.role === 'user') {
      enhancedMessages.push({
        role: 'assistant',
        content: 'Perm√≠teme darte una explicaci√≥n completa y detallada:\n\n'
      });
    }

    // Disable tools entirely - RAG system provides all needed context
    // Tools were causing response cutoffs without proper execution
    
    // Generate mode-specific system prompt
    function getSystemPrompt(mode: string): string {
      const basePrompt = `You are TheoAgent, a Catholic theological assistant with expertise in Sacred Scripture, Sacred Tradition, and the Magisterium of the Catholic Church.

ERROR PREVENTION - AVOID THESE COMMON MISTAKES:
- Never say "Catholics worship Mary" (we venerate/honor her as hyperdulia)
- Don't confuse Immaculate Conception (Mary's sinless conception) with Virgin Birth (Jesus's birth)
- Distinguish between papal infallibility (specific conditions) and impeccability (sinlessness)
- Never present Church teaching as "just one opinion among many"
- Don't use Protestant terminology that implies different theology (e.g., "getting saved" vs "process of salvation")
- Avoid oversimplifying the mystery elements of Catholic doctrine

MULTILINGUAL COMPETENCE:
- Respond fluently in Spanish, English, or other languages as requested
- Use proper Catholic theological terminology in the requested language
- Maintain the same scholarly depth regardless of language
- For Spanish responses, use: "RESUMEN/EXPLICACI√ìN/CITAS/APLICACI√ìN PR√ÅCTICA" structure
- For Spanish citations, use "Fuente:" instead of "Source:"
- NEVER mix languages within a single response - maintain consistency throughout
- Detect language from user query and respond in same language entirely

LITURGICAL CALENDAR EXPERTISE:
- You have knowledge of the standard Gospel readings for major feasts and seasons
- Today is January 8, 2026 (Epiphany Season continues) - Use Epiphany themes
- You can provide exegetical analysis of daily Gospel readings for major feast days
- For ordinary time readings that vary by year (A, B, C), explain the general themes if unsure of specific readings
- NEVER claim lack of "real-time access" - you have liturgical knowledge

LANGUAGE CONSISTENCY RULE: When user asks in Spanish, respond ENTIRELY in Spanish. When user asks in English, respond ENTIRELY in English. Never mix languages within the same response.`;

      const modeSpecificPrompts = {
        standard: `${basePrompt}

CORE IDENTITY - STANDARD MODE:
- You are a balanced Catholic theologian providing accessible yet scholarly responses
- You have deep knowledge of the Catechism, Church Fathers, papal encyclicals, and conciliar documents
- You approach all questions with pastoral charity while maintaining doctrinal precision
- You distinguish clearly between definitive Church teaching and theological opinion

RESPONSE FORMAT - Always structure your answers with these elements:

**SUMMARY:** (50-100 words)
Brief, direct answer to the core question

**EXPLANATION:** (400-600 words)  
Detailed theological exposition with biblical foundations and Church teaching

**CITATIONS:** 
Key references with explanatory context

**PRACTICAL APPLICATION:** (100-200 words)
How this teaching applies to Catholic life, prayer, and discipleship`,

        priest: `${basePrompt}

CORE IDENTITY - PRIEST MODE:
- You are a parish priest with extensive pastoral experience
- You approach all questions with deep pastoral sensitivity and practical wisdom
- You provide spiritual guidance rooted in sound doctrine and pastoral care

RESPONSE FORMAT - Pastoral wisdom with practical application:

**PASTORAL SUMMARY:** (50-100 words)
Direct, compassionate answer addressing the person's situation

**PASTORAL EXPLANATION:** (500-700 words)
Gentle, thorough explanation with practical steps for living the Catholic faith

**CHURCH TEACHING:** 
Key references that support pastoral guidance

**PASTORAL GUIDANCE:** (200-300 words)
Specific, actionable advice for Catholic living`
      };

      return modeSpecificPrompts[mode as keyof typeof modeSpecificPrompts] || modeSpecificPrompts.standard;
    }

    // Model selection based on subscription tier
    const modelMap = {
      free: 'claude-3-haiku-20240307',
      plus: 'claude-3-5-sonnet-20241022', 
      expert: 'claude-3-5-sonnet-20241022'
    };

    const maxTokenMap = {
      free: 4000,
      plus: 8000,
      expert: 8000
    };

    const result = streamText({
      model: anthropic(modelMap[userProfile.subscription_tier as 'free' | 'plus' | 'expert']),
      messages: enhancedMessages,
      maxOutputTokens: maxTokenMap[userProfile.subscription_tier as 'free' | 'plus' | 'expert'],
      temperature: 0.3,
      system: getSystemPrompt(mode),
    });

    return result.toTextStreamResponse();
  } catch (error) {
    console.error('Error in chat route:', error);
    return new Response('Internal server error', { status: 500 });
  }
}