// QUICK START: Enabling Context Injection (RAG)
// This shows you exactly how to modify your API route to inject custom data

import { streamText } from 'ai';
import { anthropic } from '@ai-sdk/anthropic';
import { gatherContextForQuery } from '@/lib/dataInjection';

export const maxDuration = 60;

export async function POST(req: Request) {
  const { messages } = await req.json();
  
  // Extract the user's latest message
  const lastMessage = messages[messages.length - 1];
  const userQuery = lastMessage?.content || '';
  
  // ===== NEW: Gather relevant context from your data =====
  const relevantContext = gatherContextForQuery(userQuery);
  
  // ===== NEW: Inject context into the conversation =====
  let enhancedMessages = messages;
  
  if (relevantContext && lastMessage) {
    enhancedMessages = [
      ...messages.slice(0, -1),
      {
        ...lastMessage,
        content: userQuery + relevantContext
      }
    ];
  }
  // ===== END NEW CODE =====
  
  const result = streamText({
    model: anthropic('claude-sonnet-4-20250514'),
    messages: enhancedMessages, // Use enhanced messages instead of original
    system: `You are TheoAgent, a knowledgeable Catholic theology assistant.
    
When reference material is provided in the conversation, always cite it in your response.
Format catechism citations as "CCC [paragraph number]".
    
Use markdown formatting for clarity:
- **Bold** for key terms
- > Blockquotes for Scripture
- ## Headers for organization
- Bullet points for lists`,
  });

  const stream = new ReadableStream({
    async start(controller) {
      try {
        for await (const chunk of result.textStream) {
          controller.enqueue(new TextEncoder().encode(chunk));
        }
        controller.close();
      } catch (error) {
        console.error('Stream error:', error);
        controller.error(error);
      }
    },
  });

  return new Response(stream, {
    headers: { 'Content-Type': 'text/plain; charset=utf-8' },
  });
}

/*
TO ENABLE THIS:

1. Backup your current route.ts
2. Replace the contents with this file
3. Test by asking: "What are the cardinal virtues?"
4. You should see it reference the custom_teachings.json data

THAT'S IT! Now TheoAgent will automatically inject relevant context from:
- public/data/catechism.json
- public/data/custom_teachings.json

Add more JSON files and update dataInjection.ts to include them!
*/
